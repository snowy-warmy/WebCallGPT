<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Verduurzamen Voice Chat</title>
</head>
<body>
  <h1>ğŸ™ï¸ Talk to Your Verduurzamen Assistant</h1>
  <button id="start">Start Talking</button>
  <button id="stop">Stop</button>
  <audio id="assistantAudio" autoplay></audio>

  <script>
    let ws, mediaRecorder;

    document.getElementById("start").onclick = async () => {
      ws = new WebSocket(`wss://${window.location.host}`);
      ws.binaryType = "arraybuffer";

      ws.onopen = () => console.log("ğŸ”— Connected to backend");

      ws.onmessage = async (event) => {
        try {
          const msg = JSON.parse(event.data);
          if (msg.type === "response.audio.delta") {
            // Play base64 audio chunks from model
            const audioBytes = Uint8Array.from(atob(msg.delta), (c) => c.charCodeAt(0));
            const audioCtx = new AudioContext();
            const audioBuffer = await audioCtx.decodeAudioData(audioBytes.buffer);
            const src = audioCtx.createBufferSource();
            src.buffer = audioBuffer;
            src.connect(audioCtx.destination);
            src.start();
          }
        } catch (e) {
          // Ignore non-JSON chunks
        }
      };

      // Get microphone stream
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });

      mediaRecorder.ondataavailable = async (e) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          const base64Audio = reader.result.split(",")[1];
          // Send audio to Realtime API as per protocol
          ws.send(JSON.stringify({
            type: "input_audio_buffer.append",
            audio: base64Audio
          }));
          ws.send(JSON.stringify({ type: "input_audio_buffer.commit" }));
          ws.send(JSON.stringify({
            type: "response.create",
            response: {
              modalities: ["audio"],
              instructions: "Antwoord vriendelijk in het Nederlands en praat over verduurzaming."
            }
          }));
        };
        reader.readAsDataURL(e.data);
      };

      mediaRecorder.start(1500); // send every 1.5 seconds
    };

    document.getElementById("stop").onclick = () => {
      mediaRecorder?.stop();
      ws?.close();
    };
  </script>
</body>
</html>
