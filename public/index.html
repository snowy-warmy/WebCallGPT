<!DOCTYPE html>
<html lang="nl">
  <head>
    <meta charset="UTF-8" />
    <title>Verduurzaam Adviseur</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        text-align: center;
        background: #f7f8fa;
        color: #222;
        padding: 3rem;
      }
      h1 {
        margin-bottom: 0.5rem;
      }
      p {
        color: #555;
      }
      button {
        margin-top: 1rem;
        font-size: 1.1rem;
        padding: 0.8rem 1.6rem;
        border: none;
        border-radius: 8px;
        background: #10a37f;
        color: #fff;
        cursor: pointer;
      }
      button:hover {
        background: #0d8a6f;
      }
      #status {
        margin-top: 2rem;
        font-family: monospace;
        color: #333;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <h1>üéôÔ∏è Verduurzaam Adviseur</h1>
    <p>Klik op ‚ÄúStart‚Äù en praat ‚Äî de adviseur luistert en geeft direct antwoord.</p>
    <button id="start">Start</button>
    <div id="status"></div>

    <script type="module">
      const startBtn = document.getElementById("start");
      const statusDiv = document.getElementById("status");

      startBtn.onclick = async () => {
        statusDiv.innerText = "üé§ Toegang tot microfoon aanvragen...";
        const mic = await navigator.mediaDevices.getUserMedia({ audio: true });
        statusDiv.innerText = "‚úÖ Microfoon actief. Verbinden met assistent...";

        // Create RTCPeerConnection
        const pc = new RTCPeerConnection();
        let greeted = false;

        // GPT voice output
        pc.ontrack = (event) => {
          const [stream] = event.streams;
          const audioEl = document.createElement("audio");
          audioEl.autoplay = true;
          audioEl.srcObject = stream;
          document.body.appendChild(audioEl);
        };

        // Send local mic audio
        mic.getTracks().forEach((track) => pc.addTrack(track, mic));

        // Create DataChannel
        const dc = pc.createDataChannel("oai-events");
        dc.onmessage = async (evt) => {
          try {
            const msg = JSON.parse(evt.data);

            // --- Live transcription ---
            if (msg.type === "input_audio_buffer.speech_transcription.delta" && msg.delta) {
              console.log("üó£Ô∏è Gebruiker:", msg.delta);
              statusDiv.innerText = "üó£Ô∏è Jij: " + msg.delta;
            }

            // --- Text output from assistant ---
            if (msg.type === "response.output_text.delta" && msg.delta) {
              console.log("ü§ñ Adviseur:", msg.delta);
              statusDiv.innerText = "ü§ñ " + msg.delta;
            }

            // --- Emotion heuristic ---
            if (msg.type === "response.output_text.delta" && msg.delta) {
              const txt = msg.delta.toLowerCase();
              let emotion = "neutral üòê";
              if (txt.includes("mooi") || txt.includes("goed")) emotion = "positive üòä";
              else if (txt.includes("jammer") || txt.includes("helaas")) emotion = "sad üòî";
              console.log("üí≠ Likely emotion:", emotion);
            }

            // --- Handle tool calls ---
            if (msg.type === "response.tool_call") {
              if (msg.name === "save_lead") {
                const { postcode, huisnummer, telefoon } = msg.arguments || {};
                console.log("üìû Lead tool call:", msg.arguments);

                const resp = await fetch("/lead", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ postcode, huisnummer, telefoon }),
                });
                const data = await resp.json();
                console.log("‚úÖ Lead opgeslagen:", data);
                dc.send(
                  JSON.stringify({
                    type: "response.tool_output",
                    tool_call_id: msg.id,
                    output: { success: true },
                  })
                );
              }

              if (msg.name === "search") {
                console.log("üîç Search tool call:", msg.arguments);
                const q = encodeURIComponent(msg.arguments?.query || "");
                const resp = await fetch(`/search?q=${q}`);
                const data = await resp.json();
                console.log("üîé Search result:", data.result);
                dc.send(
                  JSON.stringify({
                    type: "response.tool_output",
                    tool_call_id: msg.id,
                    output: { result: data.result },
                  })
                );
              }
            }
          } catch (e) {
            console.warn("‚ö†Ô∏è Non-JSON event:", evt.data);
          }
        };

        dc.onopen = () => {
          console.log("‚úÖ DataChannel open");
          if (!greeted) {
            greeted = true;
            dc.send(
              JSON.stringify({
                type: "response.create",
                response: {
                  modalities: ["audio", "text"],
                  instructions: "Hallo, waarmee kan ik je helpen?",
                },
              })
            );
          }
        };

        // --- Create and send offer ---
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        const sdpResponse = await fetch("/session", {
          method: "GET",
        });
        const sessionData = await sdpResponse.json();
        if (!sdpResponse.ok) {
          statusDiv.innerText = "‚ùå Verbinding mislukt.";
          console.error("Session error:", sessionData);
          return;
        }

        const answerResp = await fetch(sessionData.client_secret.value, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${sessionData.client_secret.value}`,
            "Content-Type": "application/sdp",
            "OpenAI-Beta": "realtime=v1",
          },
          body: offer.sdp,
        });

        if (!answerResp.ok) {
          const err = await answerResp.text();
          console.error("‚ùå Connection failed:", err);
          statusDiv.innerText = "‚ùå Verbinding mislukt:\n" + err;
          return;
        }

        const answer = { type: "answer", sdp: await answerResp.text() };
        await pc.setRemoteDescription(answer);
        statusDiv.innerText = "‚úÖ Verbonden met Verduurzaam Adviseur. Praat nu!";
      };
    </script>
  </body>
</html>
