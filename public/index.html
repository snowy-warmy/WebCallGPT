<!DOCTYPE html>
<html lang="nl">
  <head>
    <meta charset="UTF-8" />
    <title>Verduurzaam Adviseur</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        text-align: center;
        background: #f7f8fa;
        color: #222;
        padding: 3rem;
      }
      h1 {
        margin-bottom: 0.5rem;
      }
      p {
        color: #555;
      }
      button {
        margin-top: 1rem;
        font-size: 1.1rem;
        padding: 0.8rem 1.6rem;
        border: none;
        border-radius: 8px;
        background: #10a37f;
        color: #fff;
        cursor: pointer;
      }
      button:hover {
        background: #0d8a6f;
      }
      #status {
        margin-top: 2rem;
        font-family: monospace;
        color: #333;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <h1>üéôÔ∏è Verduurzaam Adviseur</h1>
    <p>Klik op ‚ÄúStart‚Äù en praat ‚Äî de adviseur luistert en geeft direct antwoord.</p>
    <button id="start">Start</button>
    <div id="status"></div>

    <script type="module">
      const startBtn = document.getElementById("start");
      const statusDiv = document.getElementById("status");

      startBtn.onclick = async () => {
        try {
          statusDiv.innerText = "üé§ Toegang tot microfoon aanvragen...";
          const mic = await navigator.mediaDevices.getUserMedia({ audio: true });
          statusDiv.innerText = "‚úÖ Microfoon actief. Verbinden met de adviseur...";

          // 1Ô∏è‚É£ Ask server for session
          const sessionResp = await fetch("/session");
          const sessionData = await sessionResp.json();

          if (!sessionResp.ok || !sessionData?.client_secret?.value) {
            console.error("Session creation failed:", sessionData);
            statusDiv.innerText = "‚ùå Fout bij sessie creatie.";
            return;
          }

          const EPHEMERAL_KEY = sessionData.client_secret.value;
          const MODEL = sessionData.model || "gpt-4o-realtime-mini";

          // 2Ô∏è‚É£ Create WebRTC connection
          const pc = new RTCPeerConnection();

          // 3Ô∏è‚É£ Handle GPT audio
          pc.ontrack = (event) => {
            const [stream] = event.streams;
            if (stream) {
              const audioEl = document.createElement("audio");
              audioEl.autoplay = true;
              audioEl.srcObject = stream;
              document.body.appendChild(audioEl);
              statusDiv.innerText = "üó£Ô∏è Adviseur luistert en spreekt...";
            }
          };

          // 4Ô∏è‚É£ Send local mic track
          mic.getTracks().forEach((track) => pc.addTrack(track, mic));

          // 5Ô∏è‚É£ Create data channel for control & text
          const dc = pc.createDataChannel("oai-events");
          dc.onmessage = (e) => {
            const msg = JSON.parse(e.data);
            if (msg.type === "response.output_text.delta") {
              console.log("üí¨", msg.delta);
            }
          };

          dc.onopen = () => {
            console.log("‚úÖ DataChannel geopend");
            statusDiv.innerText = "ü§ñ Verbonden met de Verduurzaam Adviseur...";

            // Greet user
            dc.send(
              JSON.stringify({
                type: "response.create",
                response: {
                  modalities: ["audio", "text"],
                  instructions: "Hallo, waar kan ik je mee helpen op het gebied van verduurzamen?",
                },
              })
            );
          };

          // 6Ô∏è‚É£ Create SDP offer
          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);

          // 7Ô∏è‚É£ Send offer to OpenAI Realtime API
          const baseUrl = "https://api.openai.com/v1/realtime";
          const sdpResponse = await fetch(`${baseUrl}?model=${MODEL}`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${EPHEMERAL_KEY}`,
              "Content-Type": "application/sdp",
              "OpenAI-Beta": "realtime=v1",
            },
            body: offer.sdp,
          });

          if (!sdpResponse.ok) {
            const errText = await sdpResponse.text();
            console.error("‚ùå Verbinding mislukt:", errText);
            statusDiv.innerText = "‚ùå Verbinding mislukt.";
            return;
          }

          const answer = { type: "answer", sdp: await sdpResponse.text() };
          await pc.setRemoteDescription(answer);

          statusDiv.innerText = "‚úÖ Verbonden! Je kunt nu praten met de adviseur.";
        } catch (err) {
          console.error("‚ùå Setup error:", err);
          statusDiv.innerText = "‚ùå Verbinding mislukt.";
        }
      };
    </script>
  </body>
</html>
