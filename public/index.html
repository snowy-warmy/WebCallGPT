<!DOCTYPE html>
<html lang="nl">
  <head>
    <meta charset="UTF-8" />
    <title>Verduurzaam Adviseur</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        text-align: center;
        background: #f7f8fa;
        color: #222;
        padding: 3rem;
      }
      h1 {
        margin-bottom: 0.5rem;
      }
      p {
        color: #555;
      }
      button {
        margin-top: 1rem;
        font-size: 1.1rem;
        padding: 0.8rem 1.6rem;
        border: none;
        border-radius: 8px;
        background: #10a37f;
        color: #fff;
        cursor: pointer;
      }
      button:hover {
        background: #0d8a6f;
      }
      #status {
        margin-top: 1.5rem;
        font-family: monospace;
        color: #333;
        white-space: pre-wrap;
      }
      #emotion {
        font-size: 2rem;
        margin-top: 1rem;
      }
      #transcript {
        font-size: 0.9rem;
        color: #444;
        margin-top: 1rem;
        background: #fff;
        border-radius: 8px;
        padding: 1rem;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        text-align: left;
      }
    </style>
  </head>

  <body>
    <h1>üéôÔ∏è Verduurzaam Adviseur</h1>
    <p>Klik op ‚ÄúStart‚Äù en praat ‚Äî de adviseur luistert en reageert direct.</p>
    <button id="start">Start</button>
    <div id="status"></div>
    <div id="emotion"></div>
    <div id="transcript"></div>

    <script type="module">
      const startBtn = document.getElementById("start");
      const statusDiv = document.getElementById("status");
      const emotionDiv = document.getElementById("emotion");
      const transcriptDiv = document.getElementById("transcript");

      startBtn.onclick = async () => {
        try {
          statusDiv.innerText = "üé§ Microfoon starten...";
          const mic = await navigator.mediaDevices.getUserMedia({ audio: true });
          statusDiv.innerText = "üîó Verbinden met de Verduurzaam Adviseur...";

          // üéß Ephemeral session ophalen
          const sessionResp = await fetch("/session");
          const session = await sessionResp.json();
          if (!session?.client_secret?.value)
            throw new Error("Geen geldige sessie ontvangen.");
          const EPHEMERAL_KEY = session.client_secret.value;
          const MODEL = "gpt-realtime-mini-2025-10-06";

          // WebRTC setup
          const pc = new RTCPeerConnection();

          // üîä Ontvang GPT audio
          pc.ontrack = (event) => {
            const [stream] = event.streams;
            const audioEl = document.createElement("audio");
            audioEl.autoplay = true;
            audioEl.srcObject = stream;
            document.body.appendChild(audioEl);
            statusDiv.innerText = "üó£Ô∏è Adviseur luistert en spreekt...";
          };

          // üéôÔ∏è Verstuur lokale microfoon
          mic.getTracks().forEach((track) => pc.addTrack(track, mic));

          // üí¨ DataChannel voor control + tekst
          const dc = pc.createDataChannel("oai-events");

          // Buffer voor transcriptie
          let transcriptBuffer = "";

          dc.onmessage = async (evt) => {
            try {
              const msg = JSON.parse(evt.data);

              // üí¨ Tekst van GPT (realtime)
              if (msg.type === "response.output_text.delta") {
                statusDiv.innerText = "üí¨ " + msg.delta;
                transcriptDiv.innerText += `ü§ñ ${msg.delta}`;
              }

              if (msg.type === "response.completed") {
                transcriptDiv.innerText += "\n";
              }

              // üéß Gebruikerstranscriptie
              if (msg.type === "input_audio_buffer.speech_transcribed") {
                const text = msg.transcript?.trim();
                if (text) {
                  transcriptDiv.innerText += `üë§ ${text}\n`;
                  transcriptBuffer = text;
                  console.log("üéß Gebruiker zei:", text);

                  // üé≠ Eenvoudige emotie-inschatting
                  const t = text.toLowerCase();
                  let emotion = "üòê";
                  if (t.match(/\b(leuk|goed|top|prima|gezellig|fijn)\b/))
                    emotion = "üòä";
                  else if (t.match(/\b(denk|twijfel|misschien|uh|weet niet)\b/))
                    emotion = "ü§î";
                  else if (t.match(/\b(niet|nee|geen zin|slecht)\b/))
                    emotion = "üòû";
                  else if (t.match(/\b(boos|irritant|gedoe)\b/))
                    emotion = "üò†";

                  emotionDiv.innerText = `${emotion}`;
                  console.log(`üé≠ Gebruiker klinkt ${emotion}`);
                }
              }

              // üåç Webzoekopdracht
              if (msg.action === "search" && msg.query) {
                console.log("üîç GPT vraagt om zoekopdracht:", msg.query);
                dc.send(
                  JSON.stringify({
                    type: "response.create",
                    response: {
                      modalities: ["audio", "text"],
                      instructions: "Momentje, ik zoek dat even op...",
                    },
                  })
                );

                const resp = await fetch(`/search?q=${encodeURIComponent(msg.query)}`);
                const data = await resp.json();

                dc.send(
                  JSON.stringify({
                    type: "response.create",
                    response: {
                      modalities: ["audio", "text"],
                      instructions: `
Gebruik deze informatie in je volgende antwoord, zonder URLs te noemen.
${data.result}
                      `,
                    },
                  })
                );
              }

              // üìû Lead capture actie
              if (msg.action === "save_lead" && msg.data) {
                console.log("üìû Leadgegevens ontvangen:", msg.data);
                statusDiv.innerText = "üìû Gegevens worden opgeslagen...";
                fetch("/lead", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(msg.data),
                }).then((r) => {
                  if (r.ok)
                    statusDiv.innerText = "‚úÖ Gegevens opgeslagen. Dank je!";
                  else statusDiv.innerText = "‚ö†Ô∏è Opslaan mislukt.";
                });
              }
            } catch (e) {
              console.warn("üì® Niet-JSON event:", evt.data);
            }
          };

          dc.onopen = () => {
            console.log("‚úÖ DataChannel open ‚Äî start begroeting");
            dc.send(
              JSON.stringify({
                type: "response.create",
                response: {
                  modalities: ["audio", "text"],
                  instructions:
                    "Hallo, waar kan ik je mee helpen op het gebied van verduurzamen?",
                },
              })
            );
          };

          // SDP handshake
          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);

          const sdpResponse = await fetch(
            `https://api.openai.com/v1/realtime?model=${MODEL}`,
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${EPHEMERAL_KEY}`,
                "Content-Type": "application/sdp",
                "OpenAI-Beta": "realtime=v1",
              },
              body: offer.sdp,
            }
          );

          if (!sdpResponse.ok) {
            const err = await sdpResponse.text();
            console.error("‚ùå Verbinding mislukt:", err);
            statusDiv.innerText = "‚ùå Verbinding mislukt.";
            return;
          }

          const answer = { type: "answer", sdp: await sdpResponse.text() };
          await pc.setRemoteDescription(answer);

          statusDiv.innerText =
            "‚úÖ Verbonden! Praat gerust met de Verduurzaam Adviseur.";
        } catch (err) {
          console.error("‚ùå Setup fout:", err);
          statusDiv.innerText = "‚ùå Verbinding mislukt.";
        }
      };
    </script>
  </body>
</html>
